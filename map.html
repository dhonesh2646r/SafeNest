<!DOCTYPE html>
<html lang="en">
<head>
  <title>SafeNest Hyderabad - Route Tracker</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Real-time route tracking with safety features in Hyderabad">

  <!-- Leaflet CSS/JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Leaflet Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

  <style>
    :root {
      --primary-color: #4a6fa5;
      --safe-color: #4CAF50;
      --warning-color: #FFC107;
      --danger-color: #F44336;
      --balanced-color: #FF6D00;
    }
    
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    #map {
      height: 100vh;
      width: 100%;
    }
    
    .control-panel {
      position: absolute;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      width: 300px;
      max-width: 90%;
    }
    
    .status-bar {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 1000;
      display: flex;
      gap: 15px;
      align-items: center;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 14px;
    }
    
    select, button {
      padding: 8px 12px;
      border-radius: 4px;
      border: 1px solid #ddd;
      width: 100%;
      margin-bottom: 10px;
      font-size: 14px;
    }
    
    button {
      background-color: var(--primary-color);
      color: white;
      border: none;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    
    button:hover {
      background-color: #3a5a80;
    }
    
    .sos-button {
      background-color: var(--danger-color);
      font-weight: bold;
      margin-top: 10px;
    }
    
    .sos-button:hover {
      background-color: #d32f2f;
    }
    
    .route-option {
      display: flex;
      margin-bottom: 10px;
      align-items: center;
      font-size: 14px;
    }
    
    .route-option input {
      margin-right: 8px;
    }
    
    .safety-marker {
      background-color: var(--safe-color);
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 5px;
    }
    
    .quietness-marker {
      background-color: #9C27B0;
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 5px;
    }
    
    .balanced-marker {
      background-color: var(--balanced-color);
      border-radius: 50%;
      width: 12px;
      height: 12px;
      display: inline-block;
      margin-right: 5px;
    }
    
    .loading {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 255, 255, 0.95);
      padding: 8px 16px;
      font-size: 14px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .loading-spinner {
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--primary-color);
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 2000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.4);
    }
    
    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 400px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .close-modal {
      color: #aaa;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .close-modal:hover {
      color: black;
    }
    
    .modal-body {
      margin-bottom: 15px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .modal-input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @media (max-width: 768px) {
      .control-panel {
        top: 10px;
        right: 10px;
        width: 250px;
        padding: 10px;
      }
      
      .status-bar {
        bottom: 10px;
        font-size: 12px;
        gap: 10px;
        padding: 8px 12px;
      }
      
      .status-item {
        font-size: 12px;
      }
      
      .modal-content {
        margin: 30% auto;
      }
    }
  </style>
</head>
<body>

<!-- Destination Modal -->
<div id="destinationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Set Destination</h3>
      <span class="close-modal">&times;</span>
    </div>
    <div class="modal-body">
      <input type="text" id="destinationInput" class="modal-input" placeholder="Enter address or lat,lng">
      <div id="locationSuggestions"></div>
      <p style="font-size: 12px; color: #666;">Example: 17.4125,78.4075 or 'Gachibowli, Hyderabad'</p>
    </div>
    <div class="modal-footer">
      <button id="cancelDestination">Cancel</button>
      <button id="confirmDestination">Set Destination</button>
    </div>
  </div>
</div>

<div class="control-panel">
  <h3 style="margin-top: 0; margin-bottom: 15px;">SafeNest Hyderabad</h3>
  
  <div class="route-options">
    <div class="route-option">
      <input type="radio" id="balanced" name="routeType" value="balanced" checked>
      <label for="balanced">Balanced Route <span class="balanced-marker"></span></label>
    </div>
    <div class="route-option">
      <input type="radio" id="safest" name="routeType" value="safest">
      <label for="safest">Safest Route <span class="safety-marker"></span></label>
    </div>
    <div class="route-option">
      <input type="radio" id="quietest" name="routeType" value="quietest">
      <label for="quietest">Quietest Route <span class="quietness-marker"></span></label>
    </div>
    <div class="route-option">
      <input type="radio" id="shortest" name="routeType" value="shortest">
      <label for="shortest">Shortest Route</label>
    </div>
    <div class="route-option">
      <input type="radio" id="fastest" name="routeType" value="fastest">
      <label for="fastest">Fastest Route</label>
    </div>
  </div>
  
  <button id="updateDestination">Set Destination</button>
  <button id="shareRoute">Share My Route</button>
  <button class="sos-button" id="sosButton">EMERGENCY SOS</button>
</div>

<div class="loading" id="loading">
  <div class="loading-spinner"></div>
  <span>Initializing Hyderabad map...</span>
</div>

<div class="status-bar" id="statusBar">
  <div class="status-item">
    <span>üìç</span>
    <span id="currentLocation">Acquiring location...</span>
  </div>
  <div class="status-item">
    <span>üìè</span>
    <span id="distance">-- m</span>
  </div>
  <div class="status-item">
    <span>‚è±Ô∏è</span>
    <span id="eta">-- min</span>
  </div>
  <div class="status-item">
    <span>üîí</span>
    <span id="safetyLevel">--</span>
  </div>
  <div class="status-item">
    <span>üïí</span>
    <span id="localTime">IST</span>
  </div>
</div>

<div id="map"></div>

<script>
  // Hyderabad Configuration
  const API_BASE_URL = "http://127.0.0.1:8000";
  const ROUTE_API = `${API_BASE_URL}/start_navigation`;
  const UPDATE_POSITION_API = `${API_BASE_URL}/update_position`;
  const CHANGE_DESTINATION_API = `${API_BASE_URL}/change_destination`;
  const END_NAVIGATION_API = `${API_BASE_URL}/end_navigation`;
  const UPDATE_INTERVAL = 10000;  // 10 seconds
  const MAX_ROUTE_POINTS = 1000;
  const DESTINATION_REACHED_THRESHOLD = 20; // meters
  const DEVIATION_THRESHOLD = 50; // meters
  const HYDERABAD_BOUNDS = {
    minLat: 17.10,
    maxLat: 17.60,
    minLng: 78.30,
    maxLng: 78.70
  };
  
  // App state
  let map;
  let routeLayer;
  let userMarker;
  let destMarker;
  let currentDestination = null;
  let watchId = null;
  let lastPosition = null;
  let navigationSessionId = null;
  let positionUpdateInterval = null;
  let currentRouteType = "balanced";
  let geocoder = L.Control.Geocoder.nominatim();
  
  // Initialize map centered on Hyderabad
  function initMap() {
    map = L.map('map').setView([17.3850, 78.4867], 12);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19
    }).addTo(map);
    
    // Add geocoder control focused on Hyderabad
    L.Control.geocoder({
      defaultMarkGeocode: false,
      position: 'topleft',
      placeholder: 'Search in Hyderabad...',
      geocoder: L.Control.Geocoder.nominatim({
        geocodingQueryParams: {
          bounded: 1,
          viewbox: '78.3,17.1,78.7,17.4'
        }
      })
    })
    .on('markgeocode', function(e) {
      setDestination(e.geocode.center.lat, e.geocode.center.lng);
    })
    .addTo(map);
  }
  
  function updateDestinationMarker(lat, lng) {
    if (destMarker) {
      map.removeLayer(destMarker);
    }
    
    destMarker = L.marker([lat, lng], {
      icon: L.divIcon({
        html: 'üèÅ',
        className: 'destination-icon',
        iconSize: [30, 30]
      })
    }).addTo(map);
    
    destMarker.bindPopup(`Destination: ${lat.toFixed(5)}, ${lng.toFixed(5)}`).openPopup();
  }
  
  function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371e3;
    const œÜ1 = lat1 * Math.PI/180;
    const œÜ2 = lat2 * Math.PI/180;
    const ŒîœÜ = (lat2-lat1) * Math.PI/180;
    const ŒîŒª = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(ŒîœÜ/2) * Math.sin(ŒîœÜ/2) +
              Math.cos(œÜ1) * Math.cos(œÜ2) *
              Math.sin(ŒîŒª/2) * Math.sin(ŒîŒª/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
  }
  
  function isWithinHyderabad(lat, lng) {
    return (
      lat >= HYDERABAD_BOUNDS.minLat && 
      lat <= HYDERABAD_BOUNDS.maxLat &&
      lng >= HYDERABAD_BOUNDS.minLng && 
      lng <= HYDERABAD_BOUNDS.maxLng
    );
  }
  
  async function setDestination(lat, lng) {
    try {
      if (!isWithinHyderabad(lat, lng)) {
        throw new Error("Destination must be within Hyderabad bounds (17.10-17.60¬∞N, 78.30-78.70¬∞E)");
      }
      
      showLoading("Setting destination...");
      
      currentDestination = { lat, lng };
      updateDestinationMarker(lat, lng);
      
      if (lastPosition) {
        await endNavigationSession();
        await startNavigationSession(
          lastPosition.coords.latitude, 
          lastPosition.coords.longitude
        );
      }
    } catch (error) {
      console.error("Destination set error:", error);
      showError(error.message || "Failed to set destination");
    } finally {
      hideLoading();
    }
  }
  
  async function changeDestination(newLat, newLng) {
    try {
      if (!navigationSessionId) {
        throw new Error("No active navigation session");
      }

      if (!isWithinHyderabad(newLat, newLng)) {
        throw new Error("Destination must be within Hyderabad bounds");
      }

      showLoading("Updating destination...");
      
      const response = await fetchWithTimeout(CHANGE_DESTINATION_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          new_dest_lat: newLat,
          new_dest_lon: newLng,
          session_id: navigationSessionId
        })
      }, 30000);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.options || data.options.length === 0) {
        throw new Error("No valid route found to new destination");
      }
      
      // Update current destination
      currentDestination = { lat: newLat, lng: newLng };
      updateDestinationMarker(newLat, newLng);
      
      // Process the new route data
      processRouteData(data);
      
      return true;
      
    } catch (error) {
      console.error("Destination change error:", error);
      showError(error.message || "Failed to update destination");
      return false;
    } finally {
      hideLoading();
    }
  }

  async function startNavigationSession(currentLat, currentLng) {
    try {
      if (!currentDestination) {
        throw new Error("Please set a destination first");
      }

      showLoading("Calculating optimal route...");
      
      currentRouteType = document.querySelector('input[name="routeType"]:checked').value;
      
      const payload = {
        current_lat: parseFloat(currentLat),
        current_lon: parseFloat(currentLng),
        dest_lat: parseFloat(currentDestination.lat),
        dest_lon: parseFloat(currentDestination.lng),
        optimize_for: currentRouteType
      };

      const response = await fetchWithTimeout(ROUTE_API, {
        method: "POST",
        headers: { 
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        body: JSON.stringify(payload)
      }, 15000);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (!data.options || data.options.length === 0) {
        throw new Error("No valid route found in Hyderabad area");
      }
      
      navigationSessionId = data.session_id;
      processRouteData(data);
      startPositionUpdates();
      
    } catch (error) {
      console.error("Navigation start error:", error);
      showError(error.message || "Failed to start navigation");
      throw error;
    } finally {
      hideLoading();
    }
  }
  
  async function updatePosition(currentLat, currentLng) {
    if (!navigationSessionId) return;
    
    try {
      const response = await fetchWithTimeout(UPDATE_POSITION_API, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          current_lat: currentLat,
          current_lon: currentLng,
          session_id: navigationSessionId
        })
      }, 8000);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
      }
      
      const data = await response.json();
      
      if (data.message === "Destination reached!") {
        handleDestinationReached();
        return;
      }
      
      processRouteData(data);
      
      // Check if user has deviated significantly from route
      checkRouteDeviation(currentLat, currentLng, data.options[0].route);
      
    } catch (error) {
      console.error("Position update error:", error);
      if (error.message.includes("Navigation session not found")) {
        // Session might have expired, restart navigation
        await startNavigationSession(currentLat, currentLng);
      }
    }
  }
  
  function checkRouteDeviation(currentLat, currentLng, routeCoords) {
    if (!routeCoords || routeCoords.length < 2) return;
    
    // Find nearest point on route
    let minDistance = Infinity;
    routeCoords.forEach(coord => {
      const dist = calculateDistance(currentLat, currentLng, coord[0], coord[1]);
      if (dist < minDistance) minDistance = dist;
    });
    
    if (minDistance > DEVIATION_THRESHOLD) {
      console.log(`User deviated from route by ${minDistance.toFixed(0)}m`);
      // In a full implementation, we might trigger a re-route here
    }
  }
  
  function processRouteData(data) {
    if (routeLayer) {
      map.removeLayer(routeLayer);
    }
    
    // Use the first route option from the backend response
    const primaryRoute = data.options[0];
    const latLngs = primaryRoute.route
      .slice(0, MAX_ROUTE_POINTS)
      .map(coord => L.latLng(coord[0], coord[1]));
    
    routeLayer = L.polyline(latLngs, {
      color: getRouteColor(currentRouteType),
      weight: 6,
      opacity: 0.8,
      lineJoin: 'round'
    }).addTo(map);
    
    // Update UI
    if (primaryRoute.distance) {
      document.getElementById('distance').textContent = `${primaryRoute.distance.toFixed(0)} m`;
    }
    if (primaryRoute.estimated_time) {
      document.getElementById('eta').textContent = `${primaryRoute.estimated_time.toFixed(1)} min`;
    }
    
    // Update safety level indicator
    updateSafetyIndicator(currentRouteType, primaryRoute.safety_score);
    
    // Adjust map view
    const bounds = L.latLngBounds(latLngs);
    if (destMarker) bounds.extend(destMarker.getLatLng());
    if (userMarker) bounds.extend(userMarker.getLatLng());
    map.fitBounds(bounds, { padding: [50, 50] });
  }
  
  function updateSafetyIndicator(routeType, safetyScore) {
    const safetyElement = document.getElementById('safetyLevel');
    switch(routeType) {
      case 'safest':
        safetyElement.textContent = safetyScore ? `Safety: ${safetyScore.toFixed(1)}` : 'High Safety';
        safetyElement.style.color = 'var(--safe-color)';
        break;
      case 'quietest':
        safetyElement.textContent = 'High Quietness';
        safetyElement.style.color = '#9C27B0';
        break;
      case 'balanced':
        safetyElement.textContent = 'Balanced';
        safetyElement.style.color = 'var(--balanced-color)';
        break;
      default:
        safetyElement.textContent = 'Standard';
        safetyElement.style.color = 'inherit';
    }
  }
  
  function handleDestinationReached() {
    alert("You have reached your destination in Hyderabad!");
    endNavigationSession();
    updateUIForDestinationReached();
  }
  
  function updateUIForDestinationReached() {
    document.getElementById('distance').textContent = "0 m";
    document.getElementById('eta').textContent = "0 min";
    document.getElementById('safetyLevel').textContent = "--";
    
    if (routeLayer) {
      map.removeLayer(routeLayer);
      routeLayer = null;
    }
  }
  
  async function endNavigationSession() {
    if (!navigationSessionId) return;

    try {
      if (positionUpdateInterval) {
        clearInterval(positionUpdateInterval);
        positionUpdateInterval = null;
      }

      // Notify backend with session_id as a query parameter
      const url = `${END_NAVIGATION_API}?session_id=${encodeURIComponent(navigationSessionId)}`;
      await fetch(url, {
        method: "POST"
      });

    } catch (error) {
      console.error("Error ending navigation session:", error);
    } finally {
      navigationSessionId = null;
    }
  }
  
  function startPositionUpdates() {
    if (positionUpdateInterval) {
      clearInterval(positionUpdateInterval);
    }
    
    positionUpdateInterval = setInterval(() => {
      if (lastPosition && navigationSessionId) {
        updatePosition(
          lastPosition.coords.latitude,
          lastPosition.coords.longitude
        );
      }
    }, UPDATE_INTERVAL);
  }
  
  function getRouteColor(routeType) {
    const colors = {
      shortest: '#4285F4',  // Blue
      fastest: '#FBBC05',   // Yellow
      safest: '#0F9D58',    // Green
      quietest: '#9C27B0',  // Purple
      balanced: '#FF6D00'   // Orange
    };
    return colors[routeType] || '#4285F4';
  }
  
  function updateUserMarker(lat, lng) {
    if (!userMarker) {
      userMarker = L.marker([lat, lng], {
        icon: L.divIcon({
          html: 'üìç',
          className: 'user-icon',
          iconSize: [30, 30]
        })
      }).addTo(map);
      userMarker.bindPopup("Your location in Hyderabad").openPopup();
    } else {
      userMarker.setLatLng([lat, lng]);
    }
    
    document.getElementById('currentLocation').textContent = 
      `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  }
  
  // Update IST time display
  function updateLocalTime() {
    const options = {
      timeZone: 'Asia/Kolkata',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    };
    const timeString = new Date().toLocaleTimeString('en-IN', options);
    document.getElementById('localTime').textContent = timeString;
  }

  function handlePosition(position) {
    lastPosition = position;
    const { latitude, longitude } = position.coords;
    
    updateUserMarker(latitude, longitude);
    
    if (currentDestination && !navigationSessionId) {
      startNavigationSession(latitude, longitude);
    }
  }
  
  function handleGeolocationError(error) {
    console.error("Geolocation error:", error);
    document.getElementById('currentLocation').textContent = "Location unavailable";
    showError("Location services disabled");
  }
  
  function startTracking() {
    if (!navigator.geolocation) {
      alert("Geolocation is not supported by your browser");
      return;
    }
    
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
    }
    
    watchId = navigator.geolocation.watchPosition(
      handlePosition,
      handleGeolocationError,
      {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 15000
      }
    );
  }
  
  async function fetchWithTimeout(resource, options = {}, timeout = 8000) {
  const controller = new AbortController();
  const id = setTimeout(() => controller.abort("Timeout exceeded"), timeout);

  try {
    const response = await fetch(resource, {
      ...options,
      signal: controller.signal
    });
    clearTimeout(id);
    return response;
  } catch (error) {
    clearTimeout(id);
    if (error.name === "AbortError") {
      console.error("Fetch aborted due to timeout");
      throw new Error("Request timed out. Please try again.");
    } else {
      throw error;
    }
  }
}

  
  function showLoading(message) {
    const loadingElement = document.getElementById('loading');
    loadingElement.style.display = 'flex';
    loadingElement.querySelector('span').textContent = message;
    loadingElement.style.backgroundColor = 'rgba(255, 255, 255, 0.95)';
  }
  
  function hideLoading() {
    document.getElementById('loading').style.display = 'none';
  }
  
  function showError(message) {
    const loadingElement = document.getElementById('loading');
    loadingElement.style.display = 'flex';
    loadingElement.querySelector('span').textContent = message;
    loadingElement.style.backgroundColor = 'rgba(255, 200, 200, 0.95)';
    
    setTimeout(hideLoading, 3000);
  }

  function showDestinationModal() {
    const modal = document.getElementById('destinationModal');
    modal.style.display = "block";
    
    // Focus the input field
    document.getElementById('destinationInput').focus();
  }

  function hideDestinationModal() {
    document.getElementById('destinationModal').style.display = "none";
    document.getElementById('destinationInput').value = "";
    document.getElementById('locationSuggestions').innerHTML = "";
  }

  async function handleDestinationInput() {
    const input = document.getElementById('destinationInput').value.trim();
    
    if (input.includes(',')) {
        // Handle direct coordinates input
        const coords = input.split(',').map(coord => parseFloat(coord.trim()));
        if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
            try {
                showLoading("Validating destination...");
                
                if (!isWithinHyderabad(coords[0], coords[1])) {
                    throw new Error("Destination must be within Hyderabad bounds (17.10-17.60¬∞N, 78.30-78.70¬∞E)");
                }
                
                // Get current position if available
                const currentPos = lastPosition ? {
                    lat: lastPosition.coords.latitude,
                    lng: lastPosition.coords.longitude
                } : null;
                
                // Validate distance if we have current position
                if (currentPos) {
                    const distance = calculateDistance(currentPos.lat, currentPos.lng, coords[0], coords[1]);
                    if (distance > 10000) { // 10km in meters
                        throw new Error("Destination must be within 10km of current location");
                    }
                }
                
                // Set the destination
                await setDestination(coords[0], coords[1]);
                hideDestinationModal();
                
            } catch (error) {
                console.error("Destination change error:", error);
                showError(error.message || "Failed to update destination");
            } finally {
                hideLoading();
            }
        } else {
            showError("Invalid coordinates format. Use 'latitude,longitude'");
        }
    } else {
        // Handle address input using geocoding
        try {
            showLoading("Searching for location...");
            const results = await new Promise((resolve, reject) => {
                geocoder.geocode(input, resolve, reject);
            });
            
            if (results && results.length > 0) {
                const firstResult = results[0];
                if (!isWithinHyderabad(firstResult.center.lat, firstResult.center.lng)) {
                    throw new Error("Location found is outside Hyderabad");
                }
                
                await setDestination(firstResult.center.lat, firstResult.center.lng);
                hideDestinationModal();
            } else {
                showError("Location not found in Hyderabad");
            }
        } catch (error) {
            console.error("Geocoding error:", error);
            showError(error.message || "Failed to find location");
        } finally {
            hideLoading();
        }
    }
  }

  function setupEventListeners() {
    // Route type changes
    document.querySelectorAll('input[name="routeType"]').forEach(radio => {
      radio.addEventListener('change', async () => {
        if (lastPosition && navigationSessionId && currentDestination) {
          try {
            await startNavigationSession(
              lastPosition.coords.latitude, 
              lastPosition.coords.longitude
            );
          } catch (error) {
            console.error("Failed to change route type:", error);
          }
        }
      });
    });
    
    // Set destination button
    document.getElementById('updateDestination').addEventListener('click', showDestinationModal);
    
    // Modal close button
    document.querySelector('.close-modal').addEventListener('click', hideDestinationModal);
    
    // Modal cancel button
    document.getElementById('cancelDestination').addEventListener('click', hideDestinationModal);
    
    // Modal confirm button
    document.getElementById('confirmDestination').addEventListener('click', async () => {
      await handleDestinationInput();
    });
    
    // Allow pressing Enter in the input field
    document.getElementById('destinationInput').addEventListener('keypress', async (e) => {
      if (e.key === 'Enter') {
        await handleDestinationInput();
      }
    });
    
    // Share route button
    document.getElementById('shareRoute').addEventListener('click', () => {
      if (!currentDestination) {
        showError("No destination set to share");
        return;
      }
      
      if (navigator.share) {
        navigator.share({
          title: 'My SafeNest Hyderabad Route',
          text: `Heading to ${currentDestination.lat.toFixed(4)},${currentDestination.lng.toFixed(4)} via ${currentRouteType} route`,
          url: window.location.href
        }).catch(err => {
          console.log('Error sharing:', err);
        });
      } else {
        // Fallback for browsers without Web Share API
        const text = `My SafeNest Route: ${window.location.href}\n` +
                     `Destination: ${currentDestination.lat.toFixed(5)}, ${currentDestination.lng.toFixed(5)}\n` +
                     `Route Type: ${currentRouteType}`;
        prompt("Copy this route information:", text);
      }
    });
    
    // SOS button
    document.getElementById('sosButton').addEventListener('click', () => {
      if (!lastPosition) {
        showError("Cannot send SOS - location not available");
        return;
      }
      
      if (confirm("EMERGENCY: Send SOS alert with your location to authorities?")) {
        const position = lastPosition.coords;
        const message = `EMERGENCY ALERT!\n` +
                        `Location: ${position.latitude.toFixed(5)}, ${position.longitude.toFixed(5)}\n` +
                        `Accuracy: ${position.accuracy}m\n` +
                        `Time: ${new Date().toLocaleString()}`;
        
        // In a real app, this would send to your backend
        console.log("SOS Alert:", message);
        alert("SOS alert sent to authorities with your location!");
      }
    });
  }

  function init() {
    initMap();
    setupEventListeners();
    startTracking();
    
    // Update time every minute
    setInterval(updateLocalTime, 60000);
    updateLocalTime();
    
    setTimeout(() => {
      document.getElementById('loading').style.display = 'none';
    }, 2000);
  }
  
  document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>